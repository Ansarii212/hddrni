<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>تحضير المعلمين عبر الموقع</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCr4T8GLRxtf_6LNrokjKvmBOwSkuGO5yQ",
      authDomain: "hamsa-6009e.firebaseapp.com",
      databaseURL: "https://hamsa-6009e-default-rtdb.firebaseio.com",
      projectId: "hamsa-6009e",
      storageBucket: "hamsa-6009e.appspot.com",
      messagingSenderId: "998163671039",
      appId: "1:998163671039:web:d1930ea5b71a3a3fc729ca",
      measurementId: "G-PD1QB8X0FE"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3; // meters
      const φ1 = lat1 * Math.PI/180;
      const φ2 = lat2 * Math.PI/180;
      const Δφ = (lat2-lat1) * Math.PI/180;
      const Δλ = (lon2-lon1) * Math.PI/180;

      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

      return R * c;
    }

    window.onload = () => {
      const btn = document.getElementById("checkBtn");
      btn.onclick = () => {
        navigator.geolocation.getCurrentPosition(async (pos) => {
          const userLat = pos.coords.latitude;
          const userLng = pos.coords.longitude;

          // موقع المدرسة (غيره لما يناسبك)
          const schoolLat = 24.774265;
          const schoolLng = 46.738586;

          const distance = getDistance(userLat, userLng, schoolLat, schoolLng);
          const radius = 100; // 100 متر

          if (distance <= radius) {
            const teacherName = prompt("أدخل اسمك:");
            const now = new Date().toISOString();
            await set(ref(database, 'attendance/' + teacherName), {
              name: teacherName,
              time: now,
              latitude: userLat,
              longitude: userLng,
              status: "حاضر"
            });
            alert("تم تسجيل حضورك بنجاح.");
          } else {
            alert("أنت خارج نطاق المدرسة!");
          }
        }, (err) => {
          alert("خطأ في تحديد الموقع: " + err.message);
        });
      };
    };
  </script>
</head>
<body style="text-align:center; margin-top: 50px;">
  <h2>نظام تحضير المعلمين عبر الموقع الجغرافي</h2>
  <button id="checkBtn" style="padding:15px 30px; font-size:18px;">تسجيل الحضور</button>
</body>
</html>
